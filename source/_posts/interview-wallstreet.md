阿里的财务域的技术核心挑战主要有2点

1. 由于我们支撑了企业间的底层付款，那我们需要保证**系统的高可靠，如何避免重复付款，保证付款金额准确，拦截高危付款**是我们必须要做到的
2. 在上层业务层，我们会对接超过1000家阿里系子公司及其财务业务，那每家子公司可能都会多多少少有一些定制化逻辑在里面，比如供应商存在欠款不能付款，付款必须指定付款类型等等，那采用传统架构体系，一旦定制化逻辑达到一定的量级，就会导致逻辑与逻辑之间的交叉，代码的可维护性急剧下降，没人能说清楚改动这一块逻辑，会影响到多少上层系统。

##  阿里后端服务体系架构

- 财务域
  - 订单
    - 合同
      - 预付
      - 后付
      - 接收
  - 预付
  - 发票
  - 接收(货物)
  - 后付
  - 应付
  - 账务
- 付款域
  - 付款账号
  - 付款单据
  - 付款交易
  - 付款账务
  - 网关

### 付款流程高可靠

- 策略
  - 接口做业务幂等，支持重复调用
  - 保证付款业务的最终一致性，牺牲部分实时性
  - 最细粒度的锁，抛弃悲观锁
- 事前
  - 财务域有专门的校验接口，判断付款单据数据产生的合理性。
  - 主要是基于合同和预付以及接收之间的关系来判断付款单据的金额有无超出合同范围
- 事中

1. 创建付款单据避免并发，基于unique索引定义通用业务锁表，基于唯一业务来源ID+创建付款单据。
2. 发起付款会基于乐观锁更新付款单据状态，同时创建付款交易异步化处理付款交易。(企业间付款+海外付款等存在性能问题)
3. 针对每笔付款交易生成唯一的交易号(付款单据号+UUID)，由于银行要求每一笔付款请求对应一笔唯一的requestID，基于requestID会拦截，避免重复支付
4. 创建付款交易表的状态索引，基于状态定时查找待处理的付款交易，并发起付款，对付款交易的所有后置流程都采用乐观锁保证付款结果的准确性。
5. 基于付款状态机模型，保证消息先后顺序的问题对付款结果的最终影响。

- 事后
  - 业务数据的对账
  - 银行账号流水对账
  - 报表
  - 业务级别的监控+报警机制
    - AliMonitor

- 分布式事务
  - 支持业务级别的逆向流程，避免分布式事务问题导致的数据不一致性，如超时等。(基于SAGA模式，由业务端自己把握)

### 业务级领域模型PAAS框架-扩展点

对外提供SDK, SDK分两块，一块为业务能力，一块为扩展点

- 业务能力，也就是接口，由业务端基于自身业务对接系统的业务能力，分为必选节点和可选节点
- 对内实现了业务隔离，基于source_type和source_id
- 扩展点
  - 回调接口，主要由上层业务自身实现，除少部分必选节点外，其余全部为可选节点
  - 消息通知，业务端自身决定是否实现，比如付款成功的通知
- 业务模型基于JSON扩展字段概念，保证了整个系统架构的可扩展性
- 其他框架能力
  - 业务接口安全规范
  - 读写分离

<img src="/Users/likaer/Library/Application Support/typora-user-images/image-20210318201003764.png" alt="image-20210318201003764" style="zoom:80%;" />